extends layout

block extraHeader
  script(src='https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.min.js')
  script(src='https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.time.min.js')
  script(src='https://cdnjs.cloudflare.com/ajax/libs/flot/0.8.3/jquery.flot.resize.min.js')
  script(src='http://flot.base.is/jquery.flot.downsample.js')
  script(src='https://rawgit.com/MichaelZinsmaier/CurvedLines/master/curvedLines.js')
  script.
    
    function simple_moving_averager(period) {
        var nums = [];
        return function(num) {
            nums.push(num);
            if (nums.length > period)
                nums.splice(0,1);  // remove the first element of the array
            var sum = 0;
            for (var i in nums)
                sum += nums[i];
            var n = period;
            if (nums.length < period)
                n = nums.length;
            return(sum/n);
        }
    }

    $(function() {
      var d = new Date();
      d.setDate(d.getDate() - 1);
      $.ajax({
        url: "/temps",
        data: {st: d.getTime()}
      }).done(function( data ) {
        var bbqData = [];
        var tempData = [];

        var smaBBQ = simple_moving_averager(100);
        var smaTemp = simple_moving_averager(100);
        for(var i=0;i<data.length;i++) {
            bbqData.push([data[i].timestamp, smaBBQ(data[i].bbq)]);
            tempData.push([data[i].timestamp, smaTemp(data[i].temp)]);
        }
        bbqData = bbqData.reverse();
        tempData = tempData.reverse();

        $.plot($("#placeholder"), [
            {
                data: bbqData,
                curvedLines: {
                    apply: true  // <- set apply <- curve only this data series
                }
            },
            {
                data: tempData,
                curvedLines: {
                    apply: true  // <- set apply <- curve only this data series
                }
            }
        ], 
        { 
            xaxis: {
              mode: "time",
              timezone: "browser",
              timeformat: "%a %I%p"
            },
            series: {
              downsample: { 
                threshold: 56 
              },
              curvedLines: {
                active: true,
                nrSplinePoints: 20 // <- control nr of helper points
              }    
            }
        });

        $('#placeholder').resize(function () {
            console.log("Placeholder is now "
                + $(this).width() + "x" + $(this).height()
                + " pixels");
        });

        $('#current_indoor .temp').text(tempData[tempData.length-1][1]);
        $('#current_outdoor .temp').text(bbqData[bbqData.length-1][1]);
      });
    });

block content
  h1= title
  section(id='current_temps')
    div(id='current_indoor')
      p Indoor Temp
      p(class='temp') -
    div(id='current_outdoor')
      p Outdoor Temp
      p(class='temp') -
  div(id='placeholder' style="width:100%;height:300px")